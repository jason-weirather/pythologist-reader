

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pythologist_reader.formats.inform.immunoprofile &mdash; pythologist-reader 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> pythologist-reader
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">pythologist-reader</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../pythologist_reader.html">pythologist_reader</a> &raquo;</li>
        
      <li>pythologist_reader.formats.inform.immunoprofile</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pythologist_reader.formats.inform.immunoprofile</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pythologist_reader.formats.inform.frame</span> <span class="k">import</span> <span class="n">CellFrameInForm</span>
<span class="kn">from</span> <span class="nn">pythologist_reader.formats.inform.sets</span> <span class="k">import</span> <span class="n">CellSampleInForm</span><span class="p">,</span> <span class="n">CellProjectInForm</span>
<span class="kn">from</span> <span class="nn">pythologist_reader.formats.inform.custom</span> <span class="k">import</span> <span class="n">CellFrameInFormLineArea</span><span class="p">,</span> <span class="n">CellFrameInFormCustomMask</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkdtemp</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">copytree</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">rmtree</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pythologist_image_utilities</span> <span class="k">import</span> <span class="n">read_tiff_stack</span><span class="p">,</span> <span class="n">make_binary_image_array</span><span class="p">,</span> <span class="n">binary_image_dilation</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="k">import</span> <span class="n">uuid4</span>

<div class="viewcode-block" id="read_InFormImmunoProfileV1"><a class="viewcode-back" href="../../../../index.html#pythologist_reader.formats.inform.immunoprofile.read_InFormImmunoProfileV1">[docs]</a><span class="k">def</span> <span class="nf">read_InFormImmunoProfileV1</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                  <span class="n">save_FOXP3_intermediate_h5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">save_PD1_PDL1_intermediate_h5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">channel_abbreviations</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Foxp3 (Opal 570)&#39;</span><span class="p">:</span><span class="s1">&#39;FOXP3&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;PD-1 (Opal 620)&#39;</span><span class="p">:</span><span class="s1">&#39;PD1&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;PD-L1 (Opal 520)&#39;</span><span class="p">:</span><span class="s1">&#39;PDL1&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;CD8 (Opal 480)&#39;</span><span class="p">:</span><span class="s1">&#39;CD8&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;Cytokeratin (Opal 690)&#39;</span><span class="p">:</span><span class="s1">&#39;CYTOKERATIN&#39;</span><span class="p">},</span>
                                  <span class="n">grow_margin_steps</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                  <span class="n">microns_per_pixel</span><span class="o">=</span><span class="mf">0.496</span><span class="p">,</span>
                                  <span class="n">project_name</span> <span class="o">=</span> <span class="s1">&#39;ImmunoProfileV1&#39;</span><span class="p">,</span>
                                  <span class="n">project_id_is_project_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">skip_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">auto_fix_phenotypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">tempdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the InForm Exports from ImmunoProfile and merge them into a single CellDataFrame.</span>

<span class="sd">    This read takes place by reading in the two Exports seperately then doing a QC then combination. </span>

<span class="sd">    If identical segmentation between the exports can be garunteed upstream then this method could be modified to read the data into a single intermediate file.</span>

<span class="sd">    Structure directories as the folowing input for ``TEST_READ``:</span>

<span class="sd">    | TEST_READ/</span>
<span class="sd">    | ├── IP-99-A00001</span>
<span class="sd">    | │   └── INFORM_ANALYSIS</span>
<span class="sd">    | │       ├── FOXP3</span>
<span class="sd">    | │       ├── GIMP</span>
<span class="sd">    | │       └── PD1_PDL1</span>
<span class="sd">    | ├── IP-99-A00002</span>
<span class="sd">    | │   └── INFORM_ANALYSIS</span>
<span class="sd">    | │       ├── FOXP3</span>
<span class="sd">    | │       ├── GIMP</span>
<span class="sd">    | │       └── PD1_PDL1</span>
<span class="sd">    | └── IP-99-A00003</span>
<span class="sd">    |     └── INFORM_ANALYSIS</span>
<span class="sd">    |         ├── FOXP3</span>
<span class="sd">    |         ├── GIMP</span>
<span class="sd">    |         └── PD1_PDL1</span>

<span class="sd">    Or a single sample such as ``IP-99-A00001``:</span>

<span class="sd">    | IP-99-A00001/</span>
<span class="sd">    | └── INFORM_ANALYSIS</span>
<span class="sd">    |     ├── FOXP3</span>
<span class="sd">    |     ├── GIMP</span>
<span class="sd">    |     └── PD1_PDL1</span>


<span class="sd">    Args: </span>
<span class="sd">        path (str): location of the ImmunoProfile sample or folder of samples</span>
<span class="sd">        save_FOXP3_intermediate_h5 (str): path to save the FOXP3 export images as h5.  Keep this one if you want to tie the CellDataFrame to the images.</span>
<span class="sd">        save_PD1_PDL1_intermediate_h5 (str): path to save the PD1_PDL1 export images as h5. Probably do not save this unless you are trying to debug a failed import.</span>
<span class="sd">        channel_abbreviations (dict): convert stain names to abbreviations</span>
<span class="sd">        grow_margin_steps (int): number of pixels to grow the margin</span>
<span class="sd">        microns_per_pixel (float): conversion factor for pixels to microns</span>
<span class="sd">        project_name (str): name of the project</span>
<span class="sd">        verbose (bool): if true print extra details</span>
<span class="sd">        skip_margin (bool): if false (default) read in margin line and define a margin acording to steps.  if true, only read a tumor and stroma.</span>
<span class="sd">        auto_fix_phenotypes (bool): if true (default) automatically try to fill in any missing phenotypes with zero-values.  This most commonly happens when there are no CD8&#39;s on an image and thus the image is not phenotyped for them.</span>
<span class="sd">        project_id_is_project_name (bool): if true (default) make the project_id be the same as your project_name.  This will make concatonating sample dataframes simpler.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Pass,Fail (tuple of CellData Frames) Pass is the CellDataFrame to use which is based on the FOXP3 intermediate h5 and has PD1 and PDL1 scoring added to it.  Fail should be empty if the Exports were equivelent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=========Reading FOXP3 Export=========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># If user is trying to specify a tempdir make it if its not already there</span>
    <span class="k">if</span> <span class="n">tempdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tempdir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

    <span class="n">use_temp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># make tempdir if we need it</span>
    <span class="k">if</span> <span class="n">save_FOXP3_intermediate_h5</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">save_PD1_PDL1_intermediate_h5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">use_temp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tempdir</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_FOXP3_intermediate_h5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_FOXP3_intermediate_h5</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span><span class="s1">&#39;FOXP3.h5&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FOXP3 intermedate file is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">save_FOXP3_intermediate_h5</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cpi1</span> <span class="o">=</span> <span class="n">CellProjectInFormImmunoProfile</span><span class="p">(</span><span class="n">save_FOXP3_intermediate_h5</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">cpi1</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;FOXP3&#39;</span><span class="p">,</span><span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                <span class="n">channel_abbreviations</span><span class="o">=</span><span class="n">channel_abbreviations</span><span class="p">,</span>
                                <span class="n">steps</span><span class="o">=</span><span class="n">grow_margin_steps</span><span class="p">,</span>
                                <span class="n">microns_per_pixel</span><span class="o">=</span><span class="n">microns_per_pixel</span><span class="p">,</span>
                                <span class="n">skip_margin</span><span class="o">=</span><span class="n">skip_margin</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=========Reading PD1 PDL1 Export=========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_PD1_PDL1_intermediate_h5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_PD1_PDL1_intermediate_h5</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span><span class="s1">&#39;PD1_PDL1.h5&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PD1_PDL1 intermedate file is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">save_PD1_PDL1_intermediate_h5</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cpi2</span> <span class="o">=</span> <span class="n">CellProjectInFormImmunoProfile</span><span class="p">(</span><span class="n">save_PD1_PDL1_intermediate_h5</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">cpi2</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;PD1_PDL1&#39;</span><span class="p">,</span><span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                   <span class="n">channel_abbreviations</span><span class="o">=</span><span class="n">channel_abbreviations</span><span class="p">,</span>
                                   <span class="n">steps</span><span class="o">=</span><span class="n">grow_margin_steps</span><span class="p">,</span>
                                   <span class="n">microns_per_pixel</span><span class="o">=</span><span class="n">microns_per_pixel</span><span class="p">,</span>
                                   <span class="n">skip_margin</span><span class="o">=</span><span class="n">skip_margin</span><span class="p">)</span>
    <span class="n">cdf1</span> <span class="o">=</span> <span class="n">cpi1</span><span class="o">.</span><span class="n">cdf</span>
    <span class="n">cdf2</span> <span class="o">=</span> <span class="n">cpi2</span><span class="o">.</span><span class="n">cdf</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=======Merging FOXP3 with PD1 PDL1 Export=======</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">cdf1</span><span class="o">.</span><span class="n">merge_scores</span><span class="p">(</span><span class="n">cdf2</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;project_name&#39;</span><span class="p">,</span><span class="s1">&#39;sample_name&#39;</span><span class="p">,</span><span class="s1">&#39;frame_name&#39;</span><span class="p">,</span><span class="s1">&#39;cell_index&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">auto_fix_phenotypes</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=======Quick QC 1=========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">qc</span><span class="p">()</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">run_tests</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">qc</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">result</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">about</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Issue count: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">total</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">auto_fix_phenotypes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_uniform</span><span class="p">():</span> 
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FIXING non-uniform with zero-fill.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">zero_fill_missing_phenotypes</span><span class="p">()</span>

    <span class="n">did_fix</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">did_fix</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">zero_fill_missing_phenotypes</span><span class="p">()</span>
        <span class="n">did_fix</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=======Quick QC 2 (POST FIX)=========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">qc</span><span class="p">()</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">run_tests</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">qc</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">result</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">about</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Issue count: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">total</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">project_id_is_project_name</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;project_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;project_name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">project_id_is_project_name</span><span class="p">:</span>
        <span class="n">f</span><span class="p">[</span><span class="s1">&#39;project_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;project_name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: MISMATCHED SEGMENTATIONS FAILED TO MERGE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># If we cached files clean up</span>
    <span class="k">if</span> <span class="n">use_temp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;removing temp directory &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">f</span></div>

<div class="viewcode-block" id="CellProjectInFormImmunoProfile"><a class="viewcode-back" href="../../../../index.html#pythologist_reader.formats.inform.immunoprofile.CellProjectInFormImmunoProfile">[docs]</a><span class="k">class</span> <span class="nc">CellProjectInFormImmunoProfile</span><span class="p">(</span><span class="n">CellProjectInForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in an ImmunoProfile sample that could have either a Tumor mask alone, or a Tumor mask and a hand drawn margin,</span>
<span class="sd">    this will read the two projects into a cell project.  This will only read in one InForm export at a time.</span>

<span class="sd">    Accessed via ``read_path`` with the additonal parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">create_cell_sample_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CellSampleInFormImmunoProfile</span><span class="p">()</span>
<div class="viewcode-block" id="CellProjectInFormImmunoProfile.read_path"><a class="viewcode-back" href="../../../../index.html#pythologist_reader.formats.inform.immunoprofile.CellProjectInFormImmunoProfile.read_path">[docs]</a>    <span class="k">def</span> <span class="nf">read_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">,</span>
                      <span class="n">export_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">project_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">channel_abbreviations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">require_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">microns_per_pixel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">steps</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                      <span class="n">skip_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in the project folder</span>

<span class="sd">        called by ``read_InFormImmunoProfileV1`` see that function for detailed input descriptions</span>

<span class="sd">        Args: </span>
<span class="sd">            path (str): location of the project directory</span>
<span class="sd">            export_name (str): specify the name of the export to read (required)</span>
<span class="sd">            project_name (str): name of the project</span>
<span class="sd">            channel_abbreviations (dict): dictionary of shortcuts to translate to simpler channel names</span>
<span class="sd">            verbose (bool): if true print extra details</span>
<span class="sd">            require (bool): if true (default), require that channel componenet image be present</span>
<span class="sd">            require_score (bool): if true (default), require there be a score file in the data</span>
<span class="sd">            microns_per_pixel (float): conversion factor</span>
<span class="sd">            steps (int): number of pixels to grow the margin</span>
<span class="sd">            skip_margin (bool): if false (default) read in margin line and define a margin acording to steps.  if true, only read a tumor and stroma.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">export_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;specify the name of the panel to read&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="k">if</span> <span class="n">microns_per_pixel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">microns_per_pixel</span> <span class="o">=</span> <span class="n">microns_per_pixel</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;microns_per_pixel &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microns_per_pixel</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: cannot write to a path in read-only mode.&quot;</span><span class="p">)</span>
        <span class="c1"># read all terminal folders as sample_names unless there is none then the sample name is blank</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error project path must be a directory&quot;</span><span class="p">)</span>
        <span class="n">sample_dirs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">export_name</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expecting an IP path structure&quot;</span><span class="p">)</span>
            <span class="n">bpath1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bpath1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;INFORM_ANALYSIS&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bpath1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expecting an IP path structure&quot;</span><span class="p">)</span>
            <span class="n">sample_dirs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sample_dirs</span><span class="p">:</span>
            <span class="c1">#sname = None</span>
            <span class="c1">#if sample_name_index is None: sname = s</span>
            <span class="n">sname</span>  <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_sample_path</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">sample_name</span><span class="o">=</span><span class="n">sname</span><span class="p">,</span>
                                         <span class="n">channel_abbreviations</span><span class="o">=</span><span class="n">channel_abbreviations</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">require</span><span class="o">=</span><span class="n">require</span><span class="p">,</span>
                                         <span class="n">require_score</span><span class="o">=</span><span class="n">require_score</span><span class="p">,</span>
                                         <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
                                         <span class="n">skip_margin</span><span class="o">=</span><span class="n">skip_margin</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Added sample &quot;</span><span class="o">+</span><span class="n">sid</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CellSampleInFormImmunoProfile"><a class="viewcode-back" href="../../../../index.html#pythologist_reader.formats.inform.immunoprofile.CellSampleInFormImmunoProfile">[docs]</a><span class="k">class</span> <span class="nc">CellSampleInFormImmunoProfile</span><span class="p">(</span><span class="n">CellSampleInForm</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_cell_frame_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CellFrameInFormLineArea</span><span class="p">()</span> <span class="c1"># this will be called when we read the HDF</span>
    <span class="k">def</span> <span class="nf">create_cell_frame_class_line_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CellFrameInFormLineArea</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">create_cell_frame_class_custom_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CellFrameInFormCustomMask</span><span class="p">()</span>
<div class="viewcode-block" id="CellSampleInFormImmunoProfile.read_path"><a class="viewcode-back" href="../../../../index.html#pythologist_reader.formats.inform.immunoprofile.CellSampleInFormImmunoProfile.read_path">[docs]</a>    <span class="k">def</span> <span class="nf">read_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">sample_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">channel_abbreviations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">require</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">require_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">steps</span><span class="o">=</span><span class="mi">76</span><span class="p">,</span>
                            <span class="n">skip_margin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sample_name</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Path input must be a directory&#39;</span><span class="p">)</span>
        <span class="n">absdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;_cell_seg_data.txt$&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There needs to be cell_seg_data in the folder.&quot;</span><span class="p">)</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">skip_margin</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;FORCE SKIP ANY MARGIN FILES.. Tumor and Stroma Only</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(.*)cell_seg_data.txt$&#39;</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;score_data.txt&#39;</span><span class="p">)</span>
            <span class="c1">#summary = os.path.join(path,m.group(1)+&#39;cell_seg_data_summary.txt&#39;)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#print(path)</span>
            <span class="n">binary_seg_maps</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;binary_seg_maps.tif&#39;</span><span class="p">)</span>
            <span class="n">component_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;component_data.tif&#39;</span><span class="p">)</span>
            <span class="n">tfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;tissue_seg_data.txt&#39;</span><span class="p">)</span>
            <span class="n">tumor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="s1">&#39;GIMP&#39;</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Tumor.tif&#39;</span><span class="p">)</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="s1">&#39;GIMP&#39;</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Invasive_Margin.tif&#39;</span><span class="p">)</span>
            <span class="n">tissue_seg_data</span> <span class="o">=</span> <span class="n">tfile</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tfile</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Missing score file &#39;</span><span class="o">+</span><span class="n">score</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Acquiring frame &#39;</span><span class="o">+</span><span class="n">data</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">margin</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_margin</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LINE AREA TYPE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cell_frame_class_line_area</span><span class="p">()</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">read_raw</span><span class="p">(</span><span class="n">frame_name</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span>
                             <span class="n">cell_seg_data_file</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                             <span class="n">score_data_file</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                             <span class="n">tissue_seg_data_file</span><span class="o">=</span><span class="n">tissue_seg_data</span><span class="p">,</span>
                             <span class="n">binary_seg_image_file</span><span class="o">=</span><span class="n">binary_seg_maps</span><span class="p">,</span>
                             <span class="n">component_image_file</span><span class="o">=</span><span class="n">component_image</span><span class="p">,</span>
                             <span class="n">channel_abbreviations</span><span class="o">=</span><span class="n">channel_abbreviations</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                             <span class="n">require</span><span class="o">=</span><span class="n">require</span><span class="p">)</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">set_line_area</span><span class="p">(</span><span class="n">margin</span><span class="p">,</span><span class="n">tumor</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;TUMOR MASK ONLY TYPE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cell_frame_class_custom_mask</span><span class="p">()</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">read_raw</span><span class="p">(</span><span class="n">frame_name</span> <span class="o">=</span> <span class="n">frame</span><span class="p">,</span>
                         <span class="n">cell_seg_data_file</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">score_data_file</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                         <span class="n">tissue_seg_data_file</span><span class="o">=</span><span class="n">tissue_seg_data</span><span class="p">,</span>
                         <span class="n">binary_seg_image_file</span><span class="o">=</span><span class="n">binary_seg_maps</span><span class="p">,</span>
                         <span class="n">component_image_file</span><span class="o">=</span><span class="n">component_image</span><span class="p">,</span>
                         <span class="n">channel_abbreviations</span><span class="o">=</span><span class="n">channel_abbreviations</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                         <span class="n">require</span><span class="o">=</span><span class="n">require</span><span class="p">,</span>
                         <span class="n">require_score</span><span class="o">=</span><span class="n">require_score</span><span class="p">)</span>
                <span class="n">stroma_name</span> <span class="o">=</span> <span class="s1">&#39;Stroma-No-Margin&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">margin</span><span class="p">)</span> <span class="ow">and</span> <span class="n">skip_margin</span><span class="p">:</span> <span class="n">stroma_name</span> <span class="o">=</span> <span class="s1">&#39;Stroma-Ignore-Margin&#39;</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">set_area</span><span class="p">(</span><span class="n">tumor</span><span class="p">,</span><span class="s1">&#39;Tumor&#39;</span><span class="p">,</span><span class="n">stroma_name</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">frame_id</span> <span class="o">=</span> <span class="n">cid</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="p">[</span><span class="n">frame_id</span><span class="p">]</span><span class="o">=</span><span class="n">cid</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;frame_id&#39;</span><span class="p">:</span><span class="n">frame_id</span><span class="p">,</span><span class="s1">&#39;frame_name&#39;</span><span class="p">:</span><span class="n">frame</span><span class="p">,</span><span class="s1">&#39;frame_path&#39;</span><span class="p">:</span><span class="n">absdir</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;finished tumor and stroma and margin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;db_id&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span> <span class="o">=</span> <span class="n">sample_name</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jason L Weirather

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>